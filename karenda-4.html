<!DOCTYPE html>
<html>
<head>
    <title>家計簿アプリケーション(家計簿)</title>
    <style>
        table {
            border-collapse: collapse;
            width: 100%;
        }

        th, td {
            border: 1px solid black;
            padding: 8px;
            text-align: left;
        }
    </style>
</head>
<body>
    <ul>
        <li><a href="./home.html">ホーム</a></li>
    </ul>
    <form id="kiroku">
        <dl>
            <dt>入出費</dt>
            <dd>
                <input type="radio" id="purasuokane" name="purasuokane" value="収入" required>収入
                <input type="radio" id="purasuokane" name="purasuokane" value="出費" required>出費
            </dd>
    
            <dt>金額</dt>
            <dd><input type="text" pattern="^[1-9][0-9]*$" id="okane" required placeholder="半角数字"></dd>
   
            <dt>費目</dt>
            <dd><input type="text" id="himoku"></dd>
    
            <dt>日付</dt>
            <dd><input type="date" id="hiniti" required></dd>
        </dl>
        <input type="submit" id="sousin">
    </form>
   
    <!-- 入力内容を表示するテーブル -->
    <table id="myTable">
        <thead>
            <tr>
                <th>入出費</th>
                <th>金額</th>
                <th>費目</th>
                <th>日付</th>
                <th>操作</th> <!-- 新しい列を追加して削除ボタンを表示 -->
            </tr>
        </thead>
        <tbody id="inputList">
            <!-- 入力内容の行はここに追加されます -->
        </tbody>
        <tfoot>
            <tr>
                <td colspan="4" id="totalCell">合計: 0</td>
            </tr>
        </tfoot>
    </table>
    <button id="clearButton">合計データを削除</button>
    <!-- JavaScriptでフォーム内容を取得、表示・保存・削除するコード -->
    <script>
        var total = 0;

        const form = document.getElementById('kiroku');
        const inputList = document.getElementById('inputList');
        const totalCell = document.getElementById('totalCell');
        const storageKey = 'kirokuData';

        function loadFromLocalStorage() {
            const savedData = localStorage.getItem(storageKey);
            if (savedData) {
                const data = JSON.parse(savedData);
                total = data.total;
                totalCell.textContent = '合計: ' + total;

                for (const item of data.items) {
                    addNewRow(item.purasuokane, item.okane, item.himoku, item.hiniti, item.rowId);
                }
            }
        }

        function addNewRow(purasuokane, okane, himoku, hiniti, rowId) {
            const newRow = inputList.insertRow();
            newRow.id = rowId || generateUniqueId(); // 一意のIDを生成

            const cell1 = newRow.insertCell(0);
            const cell2 = newRow.insertCell(1);
            const cell3 = newRow.insertCell(2);
            const cell4 = newRow.insertCell(3);
            const cell5 = newRow.insertCell(4);

            cell1.textContent = purasuokane;
            cell2.textContent = okane;
            cell3.textContent = himoku;
            cell4.textContent = hiniti;
            cell5.innerHTML = `<button class="deleteButton" data-row-id="${newRow.id}">削除</button>`;

            if (purasuokane === "収入") {
                newRow.style.backgroundColor = 'rgba(0, 0, 255, 0.3)';
            } else if (purasuokane === "出費") {
                newRow.style.backgroundColor = 'rgba(255, 0, 0, 0.3)';
            }
        }

        function generateUniqueId() {
            return 'row-' + Date.now();
        }

        loadFromLocalStorage();

        form.addEventListener('submit', function (event) {
            event.preventDefault();

            const purasuokane = document.querySelector('input[name="purasuokane"]:checked').value;
            const okane = document.getElementById('okane').value;
            const himoku = document.getElementById('himoku').value;
            const hiniti = document.getElementById('hiniti').value;
            // 計算して total に加算または減算
            var okaneValue = parseFloat(okane);
            if (!isNaN(okaneValue)) {
                if (purasuokane === "収入") {
                    total += okaneValue; // 収入の場合、金額を加算
                } else if (purasuokane === "出費") {
                    total -= okaneValue; // 出費の場合、金額を減算
                }
            }

            // 新しい行を作成してテーブルに追加
            addNewRow(purasuokane, okane, himoku, hiniti);

            // フォームをクリア
            form.reset();

            // 合計セルの数字部分を更新
            totalCell.textContent = '合計: ' + total;

            // 入力データをオブジェクトとして保存
            const savedData = {
                total: total,
                items: []
            };

            // テーブル内の行データを保存データに追加
            const rows = inputList.getElementsByTagName('tr');
            for (let i = 1; i < rows.length; i++) { // i=0はヘッダ行なのでスキップ
                const cells = rows[i].getElementsByTagName('td');
                const itemData = {
                    purasuokane: cells[0].textContent,
                    okane: cells[1].textContent,
                    himoku: cells[2].textContent,
                    hiniti: cells[3].textContent,
                    rowId: rows[i].id // 行の一意のIDも保存
                };
                savedData.items.push(itemData);
            }

            // ローカルストレージに保存
            localStorage.setItem(storageKey, JSON.stringify(savedData));
        });

        // 削除ボタンをクリックした時の処理
        inputList.addEventListener('click', function (event) {
            if (event.target.classList.contains('deleteButton')) {
                const rowId = event.target.getAttribute('data-row-id');
                deleteRowById(rowId);
            }
        });

        // IDを持つ行を削除する関数
        function deleteRowById(rowId) {
            const row = document.getElementById(rowId);
            if (row) {
                const okaneValue = parseFloat(row.cells[1].textContent);
                if (!isNaN(okaneValue)) {
                    if (row.cells[0].textContent === "収入") {
                        total -= okaneValue; // 収入行を削除した場合、金額を減算
                    } else if (row.cells[0].textContent === "出費") {
                        total += okaneValue; // 出費行を削除した場合、金額を加算
                    }
                    totalCell.textContent = '合計: ' + total; // 合計セルの数字部分を更新
                }
                row.remove(); // 行を削除
                updateLocalStorage(); // ローカルストレージを更新
            }
        }

        // ローカルストレージを更新する関数
        function updateLocalStorage() {
            const savedData = {
                total: total,
                items: []
            };
            const rows = inputList.getElementsByTagName('tr');
            for (let i = 1; i < rows.length; i++) { // i=0はヘッダ行なのでスキップ
                const cells = rows[i].getElementsByTagName('td');
                const itemData = {
                    purasuokane: cells[0].textContent,
                    okane: cells[1].textContent,
                    himoku: cells[2].textContent,
                    hiniti: cells[3].textContent,
                    rowId: rows[i].id
                };
                savedData.items.push(itemData);
            }
            localStorage.setItem(storageKey, JSON.stringify(savedData));
        }

 // フォームの送信ボタンをクリックしたときの処理
document.getElementById('sousin').addEventListener('click', function (event) {
    event.preventDefault();

    const category = document.querySelector('input[name="purasuokane"]:checked').value;
    const okane = parseFloat(document.getElementById('okane').value);
    const himoku = document.getElementById('himoku').value; // 費目を取得
    const hiniti = document.getElementById('hiniti').value; // 日付を取得

    const data = {
        category: category,
        okane: okane,
        himoku: himoku, // 費目をデータに追加
        hiniti: hiniti // 日付をデータに追加
    };

    const existingData = JSON.parse(localStorage.getItem('karendaData')) || [];
    existingData.push(data);
    localStorage.setItem('karendaData', JSON.stringify(existingData));

    addNewRow(category, okane, himoku, hiniti); // テーブルに行を追加

    // フォームをクリア
    document.getElementById('okane').value = '';
    document.getElementById('himoku').value = '';
    document.getElementById('hiniti').value = '';
});

// フォームに新しい行を追加する関数
function addNewRow(category, okane, himoku, hiniti) {
    const newRow = inputList.insertRow();
    newRow.id = generateUniqueId();

    const cell1 = newRow.insertCell(0);
    const cell2 = newRow.insertCell(1);
    const cell3 = newRow.insertCell(2);
    const cell4 = newRow.insertCell(3);
    const cell5 = newRow.insertCell(4);

    cell1.textContent = category;
    cell2.textContent = okane;
    cell3.textContent = himoku; // 費目
    cell4.textContent = hiniti; // 日付
    cell5.innerHTML = `<button class="deleteButton" data-row-id="${newRow.id}">削除</button>`;

    if (category === "収入") {
        newRow.style.backgroundColor = 'rgba(0, 0, 255, 0.3)';
    } else if (category === "出費") {
        newRow.style.backgroundColor = 'rgba(255, 0, 0, 0.3)';
    }
}


        // "データを削除" ボタンをクリックした時の処理
        const clearButton = document.getElementById('clearButton');
        clearButton.addEventListener('click', function () {
            localStorage.removeItem(storageKey); // ローカルストレージからデータを削除
            inputList.innerHTML = ''; // テーブル内の行を削除
            total = 0; // 合計をリセット
            totalCell.textContent = '合計: ' + total; // 合計セルを更新
        });
    </script>
</body>
</html>
