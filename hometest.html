<!DOCTYPE html>
<html>
<head>
    <title>家計簿アプリケーション</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <h1>家計簿アプリケーション</h1>

    <!-- 年と月の選択フォーム -->
    <div id="dateSelection">
        <label for="yearSelect">年:</label>
        <select id="yearSelect">
            <!-- 選択肢を動的に生成 -->
        </select>
        <label for="monthSelect">月:</label>
        <select id="monthSelect">
            <!-- 選択肢を動的に生成 -->
        </select>
        <button id="showDataButton">データを表示</button>
    </div>

    <div id="graphContainer">
        <canvas id="myChart"></canvas>
    </div>

    <script>
        const yearSelect = document.getElementById('yearSelect');
        const monthSelect = document.getElementById('monthSelect');
        const showDataButton = document.getElementById('showDataButton');
        const graphData = {
            labels: [
                '1月', '2月', '3月', '4月', '5月', '6月',
                '7月', '8月', '9月', '10月', '11月', '12月'
            ],
            datasets: [
                {
                    label: '収入',
                    data: [],
                    backgroundColor: 'green',
                },
                {
                    label: '支出',
                    data: [],
                    backgroundColor: 'red',
                },
            ],
        };

        // 年の選択肢を生成
        const currentYear = new Date().getFullYear();
        for (let year = currentYear; year >= currentYear - 10; year--) {
            const option = document.createElement('option');
            option.value = year;
            option.text = year;
            yearSelect.appendChild(option);
        }

        // 月の選択肢を生成
        for (let month = 1; month <= 12; month++) {
            const option = document.createElement('option');
            option.value = month;
            option.text = `${month}月`;
            monthSelect.appendChild(option);
        }

        showDataButton.addEventListener('click', () => {
            const selectedYear = yearSelect.value;
            const selectedMonth = monthSelect.value;
            fetchDataAndRefresh(selectedYear, selectedMonth);
        });

        function fetchDataAndRefresh(year, month) {
            // データを取得し、特定の月のデータを抽出する
            fetch(`http://localhost:3000/data?year=${year}&month=${month}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    // 月ごとのデータを生成
                    const monthlyData = new Array(12).fill(0);
                    data.forEach(item => {
                        const index = item.nichi - 1;
                        monthlyData[index] += (item.purasuokane === '収入') ? item.okane : -item.okane;
                    });

                    graphData.datasets[0].data = monthlyData.map(amount => (amount > 0) ? amount : 0);
                    graphData.datasets[1].data = monthlyData.map(amount => (amount < 0) ? -amount : 0); // 支出は正の値に変更

                    refreshChart();
                })
                .catch(error => {
                    console.error('データの取得中にエラーが発生しました:', error);
                });
        }

        function refreshChart() {
            // グラフを描画するコード
            const chartOptions = {
                scales: {
                    y: {
                        beginAtZero: true,
                    },
                },
                plugins: {
                    legend: {
                        display: true,
                    },
                },
                layout: {
                    padding: {
                        left: 20,
                        right: 20,
                        top: 20,
                        bottom: 20,
                    },
                },
            };

            const ctx = document.getElementById('myChart').getContext('2d');
            const myChart = new Chart(ctx, {
                type: 'bar',
                data: graphData,
                options: chartOptions,
            });
        }
    </script>
</body>
</html>
