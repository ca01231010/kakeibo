<!DOCTYPE html>
<html>
<head>
    <title>家計簿アプリケーション</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <h1>家計簿アプリケーション</h1>

    <!-- 年の入力フォーム -->
    <div id="dateSelection">
        <label for="yearInput">年:</label>
        <input type="text" id="yearInput" placeholder="年を入力">
        <button id="showDataButton">データを表示</button>
    </div>

    <div id="graphContainer">
        <canvas id="myChart"></canvas>
    </div>

    <script>
        const yearInput = document.getElementById('yearInput');
        const showDataButton = document.getElementById('showDataButton');
        let myChart = null; // グローバル変数として myChart を宣言

        showDataButton.addEventListener('click', () => {
            const selectedYear = yearInput.value;
            fetchDataAndRefresh(selectedYear);
        });

        function fetchDataAndRefresh(year) {
            // サーバーサイドのエンドポイントを修正
            fetch(`http://localhost:3000/data?year=${year}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    refreshGraphWithData(data);
                })
                .catch(error => {
                    console.error('データの取得中にエラーが発生しました:', error);
                });
        }

        function refreshGraphWithData(data) {
            const monthlyIncome = Array.from({ length: 12 }, () => 0);
            const monthlyExpense = Array.from({ length: 12 }, () => 0);

            data.forEach(item => {
                const month = item.tsuki;
                if (item.purasuokane === '収入') {
                    monthlyIncome[month - 1] += item.okane;
                } else {
                    monthlyExpense[month - 1] += item.okane;
                }
            });

            // 既存のチャートを破棄
            if (myChart) {
                myChart.destroy();
            }

            // 新しいチャートを描画
            const chartOptions = {
                scales: {
                    y: {
                        beginAtZero: true,
                    },
                },
                plugins: {
                    legend: {
                        display: true,
                    },
                },
                layout: {
                    padding: {
                        left: 20,
                        right: 20,
                        top: 20,
                        bottom: 20,
                    },
                },
            };

            const ctx = document.getElementById('myChart').getContext('2d');
            myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [
                        '1月', '2月', '3月', '4月', '5月', '6月',
                        '7月', '8月', '9月', '10月', '11月', '12月'
                    ],
                    datasets: [
                        {
                            label: '収入',
                            data: monthlyIncome,
                            backgroundColor: 'green',
                        },
                        {
                            label: '支出',
                            data: monthlyExpense,
                            backgroundColor: 'red',
                        },
                    ],
                },
                options: chartOptions,
            });
        }
    </script>
</body>
</html>
